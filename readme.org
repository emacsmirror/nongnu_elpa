* fj.el

This repo contains some basic functions for interacting with a Forgejo instance (such as [[https://codeberg.org][codeberg.org]]) from within Emacs.

It doesn't interact with =forge= / =magit=, which don't implement Gitea/Forgejo support and likely never will (see [[https://github.com/magit/forge/discussions/557][https://github.com/magit/forge/discussions/557]]). Nor does it attempt to follow their wonderful design (for now).

It just aims to cover a few of the bread and butter functions that will save you switching to the browser 80% of the time.

* getting started

To get going, first set =fj-host=,  =fj-user=, and =fj-token=. You can obtain a token from your profile settings on your Forgejo instance.

Once you have done so, try =fj-list-own-repos= to view your repos, or =fj-list-issues= to view issues of the current repo, or with completing-read of a repo is no repo is found. If you are already viewing a repo and want to force the prompt to choose another, call =fj-list-issues= with a prefix arg (=C-u=).

* repositories

Current repository detection should work partially automatically. If you find you are still being asked for the repo when calling a command from inside a repo with a Forgejo remote, check to make sure the local root directory matches the name of the Forgejo repo!

* features

Forgejo's API is vast. Currently =fj.el= just implements a few basic things:

** repos and repo listings:
- create new repo
- delete a repo


- search and list instance repos
- list a user's repos
- fork a repo
- star a repo
- copy clone URL of repo
- view a repo's readme
- view a repo's commit log
- list repo's stargazers
- list repo's watchers

** rich create/edit issue/comment interface.

** issues/PRs as listings
- list repo issues and PRs
- cycle between issues/PRs/all
- cycle between open/closed/all issues/PRs
- quick jump to any issue/PR or repo in a listing with imenu.
- search in repo issues/PRs


- act on an issue/PR from the listing (edit, edit title, comment, close, reopen, delete)

** viewing issues/PRs
- view issue/PR discussion
- act on issue/PR (as above, plus reply or delete comment)
- jump to mentioned user, issue or commit.
- display all issue/PR timeline items (references, commits, merges, close/reopen, edit, etc.)
- display diff of any commit
- display diff of entire PR
- merge PR
- browse URL of view or entry at point

** notifications
- view your notifications
- jump to relevant item
- toggle between viewing unread and all notifications

** user/repo settings
- update repo settings transient menu
- update user settings transient menu


- view followers
- view users followed

* dependencies
- =magit-post=, =magit-process= (for obtaining current repo)
- [[https://codeberg.org/martianh/fedi.el][fedi.el]]

* screenshots

User repos listing:

[[file:Screenshot-user.png]]

Issue view followed by repo issues listing:

[[file:Screenshot-issues.png]]

Repo search listing:

[[file:Screenshot-search.png]]

* commands index

#+BEGIN_SRC emacs-lisp :results table :colnames '("Binding" "Command" "Description") :exports results
  (let ((rows))
    (mapatoms
     (lambda (symbol)
       (when (and (string-match "^fj"
                                (symbol-name symbol))
                  (commandp symbol))
         (let* ((doc (car
                      (split-string
                       (or (documentation symbol t) "")
                       "\n")))
                (maps (list fj-link-keymap
                            fj-repo-tl-map
                            fj-user-repo-tl-mode-map
                            fj-issue-tl-mode-map
                            fj-item-view-mode-map
                            fj-repo-tl-mode-map
                            fj-compose-comment-mode-map
                            fj-compose-mode-map
                            fj-notifications-mode-map
                            fj-commits-mode-map
                            fj-users-mode-map))
                (binding-code
                 (let ((keys (where-is-internal symbol maps nil nil (command-remapping symbol))))
                   ;; just take first 2 bindings:
                   (if (> (length keys) 2)
                       (list (car keys) (cadr keys))
                     keys)))
                (binding-str (if binding-code
                                 (mapconcat #'help--key-description-fontified
                                            binding-code ", ")
                               "")))
           (push `(,binding-str ,symbol ,doc) rows)
           rows))))
    (sort rows (lambda (x y) (string-lessp (cadr x) (cadr y)))))
#+END_SRC

#+RESULTS:
| Binding   | Command                         | Description                                                         |
|-----------+---------------------------------+---------------------------------------------------------------------|
|           | fj-browse-commit                | Browse commit with SHA in REPO by OWNER.                            |
| b         | fj-browse-view                  | Brose URL of view at point.                                         |
|           | fj-commits-mode                 | Major mode for viewing repo commits.                                |
| C-c C-k   | fj-compose-cancel               | Kill new-post buffer/window. Does not POST content.                 |
|           | fj-compose-comment-mode         | Minor mode for composing comments.                                  |
|           | fj-compose-mode                 | Minor mode for composing issues and comments.                       |
| C-c C-r   | fj-compose-read-repo            | Read a repo for composing a issue or comment.                       |
| C-c C-t   | fj-compose-read-title           | Read an issue title.                                                |
|           | fj-compose-send                 | Submit the issue or comment to your Forgejo instance.               |
|           | fj-copy-item-url                | Copy URL of current item, either issue or PR.                       |
| c         | fj-create-issue                 | Create issue in current repo or repo at point in tabulated listing. |
|           | fj-delete-repo                  | Delete repo at point, if you are its owner.                         |
| <return>  | fj-do-link-action               | Do the action of the link at POS.                                   |
| <mouse-2> | fj-do-link-action-mouse         | Do the action of the link at point.                                 |
|           | fj-get-pull-commits             | Return the data for the commits of the current pull.                |
|           | fj-issue-close                  | Close ISSUE in REPO or set to STATE.                                |
|           | fj-issue-comment                | Add COMMENT to ISSUE in REPO.                                       |
|           | fj-issue-comment-edit           | Edit comment with ID in REPO.                                       |
|           | fj-issue-compose                | Compose a new post.                                                 |
|           | fj-issue-delete                 | Delete ISSUE in REPO of OWNER.                                      |
|           | fj-issue-edit                   | Edit ISSUE body in REPO.                                            |
|           | fj-issue-edit-title             | Edit ISSUE title in REPO.                                           |
|           | fj-issue-next                   | Go to next issue or comment.                                        |
|           | fj-issue-prev                   | Goto previous issue or comment.                                     |
|           | fj-issue-tl-mode                | Major mode for browsing a tabulated list of issues.                 |
| C-c C-s   | fj-issues-item-cycle            | Cycle item type listing of issues, pulls, and all.                  |
| k         | fj-issues-tl-close              | Close current issue from tabulated issues listing.                  |
| C         | fj-issues-tl-comment            | Comment on issue from tabulated issues listing.                     |
| K         | fj-issues-tl-delete             | Delete current issue from tabulated issues listing.                 |
| e         | fj-issues-tl-edit               | Edit issue from tabulated issues listing.                           |
| t         | fj-issues-tl-edit-title         | Edit issue title from issues tabulatd list view.                    |
|           | fj-issues-tl-reload             | Reload current issues tabulated list view.                          |
| o         | fj-issues-tl-reopen             | Reopen current issue from tabulated issues listing.                 |
| v         | fj-issues-tl-view               | View current issue from tabulated issues listing.                   |
|           | fj-item-view                    | View item NUMBER from REPO of OWNER.                                |
|           | fj-item-view-close              | Close item being viewed, or set to STATE.                           |
|           | fj-item-view-comment            | Comment on the item currently being viewed.                         |
|           | fj-item-view-comment-delete     | Delete comment at point.                                            |
|           | fj-item-view-edit               | Edit the item currently being viewed.                               |
|           | fj-item-view-edit-comment       | Edit the comment at point.                                          |
|           | fj-item-view-edit-item-at-point | Edit issue or comment at point in item view mode.                   |
|           | fj-item-view-mode               | Major mode for viewing items.                                       |
|           | fj-item-view-reload             | Reload the current item view.                                       |
|           | fj-item-view-reopen             | Reopen item being viewed.                                           |
| C-M-q     | fj-kill-all-buffers             | Kill all fj buffers.                                                |
| I         | fj-list-issues                  | Display ISSUES in a tabulated list view.                            |
|           | fj-list-issues-+-pulls          | List issues and pulls for REPO by OWNER, filtered by STATE.         |
|           | fj-list-issues-all              | Display all ISSUES for REPO by OWNER in tabulated list view.        |
|           | fj-list-issues-closed           | Display closed ISSUES for REPO by OWNER in tabulated list view.     |
| C-c C-c   | fj-list-issues-cycle            | Cycle between listing of open, closed, and all issues.              |
|           | fj-list-issues-search           | Search current repo issues for QUERY.                               |
| O         | fj-list-own-repos               | List repos for `fj-user'.                                           |
| P         | fj-list-pulls                   | List pulls for REPO by OWNER, filtered by STATE.                    |
| u         | fj-list-user-repos              | View repos of current entry user from tabulated repos listing.      |
|           | fj-merge-pull                   | Merge pull request of current view or at point.                     |
|           | fj-next-tab-item                | Jump to next tab item.                                              |
|           | fj-notifications-mode           | Major mode for viewing notifications.                               |
|           | fj-notifications-unread-toggle  | Switch between showing all notifications, and only showing unread.  |
|           | fj-prev-tab-item                | Jump to prev tab item.                                              |
|           | fj-pull-req-comment             | Add comment to PULL in REPO.                                        |
|           | fj-repo-commit-log              | Render log of commits for REPO by OWNER.                            |
| L, U      | fj-repo-copy-clone-url          | Add the clone_url of repo at point to the kill ring.                |
|           | fj-repo-create                  | Create a new repo.                                                  |
|           | fj-repo-search                  | Search repos for QUERY.                                             |
| s         | fj-repo-search-tl               | Search repos for QUERY, and display a tabulated list of results.    |
|           | fj-repo-search-tl-topic         | Search repo topics for QUERY, and display a tabulated list.         |
|           | fj-repo-stargazers              | Render stargazers for REPO by OWNER.                                |
|           | fj-repo-tl-fork                 | Fork repo entry at point.                                           |
| RET       | fj-repo-tl-list-issues          | View issues of current repo from tabulated repos listing.           |
|           | fj-repo-tl-mode                 | Mode for displaying a tabulated list of repo search results.        |
|           | fj-repo-tl-readme               | Display readme file of current repo.                                |
| g         | fj-repo-tl-reload               | Reload current user repos tl.                                       |
| *         | fj-repo-tl-star-repo            | Star or UNSTAR current repo from tabulated user repos listing.      |
|           | fj-repo-tl-stargazers           | Prompt for a repo stargazer, and view their repos.                  |
|           | fj-repo-tl-unstar-repo          | Unstar current repo from tabulated user repos listing.              |
| R         | fj-repo-update-settings         | A transient for setting current repo settings.                      |
|           | fj-repo-watchers                | Render watchers for REPO by OWNER.                                  |
|           | fj-starred-repos                | List your starred repos.                                            |
| /         | fj-switch-to-buffer             | Switch to a live fj buffer.                                         |
| B         | fj-tl-browse-entry              | Browse URL of tabulated list entry at point.                        |
|           | fj-update-repo                  | Update current repo settings.                                       |
|           | fj-update-topics                | Update repo topics on the server.                                   |
|           | fj-update-user-settings         | Update current user settings on the server.                         |
|           | fj-user-followers               | View users who follow you.                                          |
|           | fj-user-following               | View users you are following.                                       |
|           | fj-user-repo-tl-mode            | Mode for displaying a tabulated list of user repos.                 |
|           | fj-user-repos-tl                | View a tabulated list of respos for USER.                           |
|           | fj-user-update-settings         | A transient for setting current user settings.                      |
|           | fj-users-mode                   | Major mode for viewing users.                                       |
|           | fj-view-commit-diff             | View a diff of a commit at point.                                   |
| N         | fj-view-notifications           | View notifications for `fj-user'.                                   |
|           | fj-view-notifications-all       | View all notifications for `fj-user'.                               |
|           | fj-view-notifications-unread    | View unread notifications for `fj-user'.                            |
| D         | fj-view-pull-diff               | View a diff of the entire current PR.                               |
|           | fj-watch-repo                   | Watch repo at point or in current view.                             |
|           | fj-watched-repos                | List your watched repos.                                            |
